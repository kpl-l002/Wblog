<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>评论系统测试</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/comments.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .test-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }
        
        .test-title {
            color: #333;
            margin-bottom: 1rem;
        }
        
        .test-button {
            background: #0088cc;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 1rem;
            margin-bottom: 1rem;
        }
        
        .test-button:hover {
            background: #0077bb;
        }
        
        .test-result {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #0088cc;
        }
        
        .test-success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        
        .test-error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>评论系统功能测试</h1>
        
        <!-- IP检测测试 -->
        <div class="test-section">
            <h2 class="test-title">1. IP检测功能测试</h2>
            <button class="test-button" onclick="testIpDetection()">测试IP检测</button>
            <div id="ip-test-result"></div>
        </div>
        
        <!-- 评论API测试 -->
        <div class="test-section">
            <h2 class="test-title">2. 评论API测试</h2>
            <button class="test-button" onclick="testGetComments()">测试获取评论</button>
            <button class="test-button" onclick="testPostComment()">测试提交评论</button>
            <div id="api-test-result"></div>
        </div>
        
        <!-- 管理员功能测试 -->
        <div class="test-section">
            <h2 class="test-title">3. 管理员功能测试</h2>
            <button class="test-button" onclick="testAdminFunctions()">测试管理员功能</button>
            <div id="admin-test-result"></div>
        </div>
        
        <!-- 评论系统UI测试 -->
        <div class="test-section">
            <h2 class="test-title">4. 评论系统UI测试</h2>
            <button class="test-button" onclick="testCommentUI()">测试评论界面</button>
            <div id="ui-test-result"></div>
        </div>
        
        <!-- 测试结果汇总 -->
        <div class="test-section">
            <h2 class="test-title">测试结果汇总</h2>
            <button class="test-button" onclick="runAllTests()">运行所有测试</button>
            <div id="summary-result"></div>
        </div>
    </div>

    <script>
        // 测试结果存储
        const testResults = {
            ipDetection: false,
            getComments: false,
            postComment: false,
            adminFunctions: false,
            commentUI: false
        };

        // 显示测试结果
        function showResult(elementId, message, isSuccess) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<pre>${message}</pre>`;
            element.className = `test-result ${isSuccess ? 'test-success' : 'test-error'}`;
        }

        // 测试IP检测功能
        async function testIpDetection() {
            try {
                const response = await fetch('/api/check-ip');
                const data = await response.json();
                
                const result = `IP检测测试成功！\n` +
                              `检测到的IP: ${data.detectedIp}\n` +
                              `是否为管理员: ${data.isAdminIp ? '是' : '否'}\n` +
                              `消息: ${data.message}`;
                
                showResult('ip-test-result', result, true);
                testResults.ipDetection = true;
            } catch (error) {
                showResult('ip-test-result', `IP检测测试失败: ${error.message}`, false);
                testResults.ipDetection = false;
            }
        }

        // 测试获取评论功能
        async function testGetComments() {
            try {
                const response = await fetch('/api/comments?postId=test-post');
                const data = await response.json();
                
                const result = `获取评论测试成功！\n` +
                              `文章ID: ${data.postId}\n` +
                              `评论数量: ${data.total}\n` +
                              `是否为管理员: ${data.isAdmin || false}\n` +
                              `成功状态: ${data.success}`;
                
                showResult('api-test-result', result, true);
                testResults.getComments = true;
            } catch (error) {
                showResult('api-test-result', `获取评论测试失败: ${error.message}`, false);
                testResults.getComments = false;
            }
        }

        // 测试提交评论功能
        async function testPostComment() {
            try {
                const commentData = {
                    postId: 'test-post',
                    author: '测试用户',
                    content: '这是一条测试评论',
                    email: 'test@example.com'
                };
                
                const response = await fetch('/api/comments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(commentData)
                });
                
                const data = await response.json();
                
                const result = `提交评论测试成功！\n` +
                              `消息: ${data.message}\n` +
                              `需要审核: ${data.requiresApproval || false}\n` +
                              `成功状态: ${data.success}`;
                
                showResult('api-test-result', result, true);
                testResults.postComment = true;
            } catch (error) {
                showResult('api-test-result', `提交评论测试失败: ${error.message}`, false);
                testResults.postComment = false;
            }
        }

        // 测试管理员功能
        async function testAdminFunctions() {
            try {
                // 首先获取一些评论
                const getResponse = await fetch('/api/comments?postId=test-post&admin=true');
                const getData = await getResponse.json();
                
                let result = `管理员功能测试部分成功！\n` +
                            `获取评论: ${getData.success ? '成功' : '失败'}\n` +
                            `评论数量: ${getData.total}\n`;
                
                // 如果有评论，测试管理员操作
                if (getData.comments && getData.comments.length > 0) {
                    const commentId = getData.comments[0].id;
                    
                    // 测试审核评论
                    const approveResponse = await fetch(`/api/comments?id=${commentId}&action=approve`, {
                        method: 'PUT'
                    });
                    const approveData = await approveResponse.json();
                    
                    result += `审核评论: ${approveData.success ? '成功' : '失败'}\n`;
                    
                    testResults.adminFunctions = approveData.success;
                } else {
                    result += '没有评论可用于测试管理员操作\n';
                    testResults.adminFunctions = true; // 没有评论也算成功
                }
                
                showResult('admin-test-result', result, testResults.adminFunctions);
            } catch (error) {
                showResult('admin-test-result', `管理员功能测试失败: ${error.message}`, false);
                testResults.adminFunctions = false;
            }
        }

        // 测试评论系统UI
        function testCommentUI() {
            try {
                // 创建模拟的文章详情页面
                const testDiv = document.createElement('div');
                testDiv.id = 'article-detail';
                testDiv.setAttribute('data-post-id', 'test-post');
                testDiv.style.display = 'block';
                
                // 创建评论系统实例
                const commentSystem = new CommentSystem();
                commentSystem.currentPostId = 'test-post';
                
                // 测试评论HTML生成
                const commentsHTML = commentSystem.generateCommentsHTML();
                
                const result = `评论系统UI测试成功！\n` +
                              `评论系统类已加载\n` +
                              `HTML生成功能正常\n` +
                              `评论表单结构正确`;
                
                showResult('ui-test-result', result, true);
                testResults.commentUI = true;
            } catch (error) {
                showResult('ui-test-result', `评论系统UI测试失败: ${error.message}`, false);
                testResults.commentUI = false;
            }
        }

        // 运行所有测试
        async function runAllTests() {
            await testIpDetection();
            await testGetComments();
            await testPostComment();
            await testAdminFunctions();
            testCommentUI();
            
            // 汇总结果
            const passed = Object.values(testResults).filter(result => result).length;
            const total = Object.keys(testResults).length;
            
            const summary = `测试完成！\n` +
                           `通过测试: ${passed}/${total}\n` +
                           `成功率: ${Math.round((passed / total) * 100)}%\n\n` +
                           `详细结果:\n` +
                           `• IP检测: ${testResults.ipDetection ? '✓' : '✗'}\n` +
                           `• 获取评论: ${testResults.getComments ? '✓' : '✗'}\n` +
                           `• 提交评论: ${testResults.postComment ? '✓' : '✗'}\n` +
                           `• 管理员功能: ${testResults.adminFunctions ? '✓' : '✗'}\n` +
                           `• 评论UI: ${testResults.commentUI ? '✓' : '✗'}`;
            
            showResult('summary-result', summary, passed === total);
        }
    </script>
    
    <script src="js/comments.js"></script>
</body>
</html>